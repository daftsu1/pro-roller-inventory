# Traefik: proxy inverso + HTTPS (solo IP)
# Certificado autofirmado se genera solo la primera vez (servicio certs-init).
# Dashboard: http://TU_IP:8080/dashboard/ (solo HTTP; el 8080 no usa HTTPS).

services:
  certs-init:
    image: alpine:3.19
    container_name: traefik_certs_init
    restart: "no"
    volumes:
      - traefik_certs:/certs
    command:
      - sh
      - -c
      - apk add --no-cache openssl && ([ -f /certs/cert.pem ] || openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /certs/key.pem -out /certs/cert.pem -subj /CN=localhost) && chmod 600 /certs/key.pem /certs/cert.pem
    networks:
      - default

  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: always
    depends_on:
      certs-init:
        condition: service_completed_successfully

    command:
      - "--configFile=/etc/traefik/static.yml"

    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"

    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - traefik_certs:/certs:ro
      - ./docker/traefik-static.yml:/etc/traefik/static.yml:ro

    environment:
      - DOCKER_API_VERSION=1.44

    networks:
      - default

networks:
  default:
    name: traefik_default

volumes:
  traefik_certs:
